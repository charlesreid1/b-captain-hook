



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://pages.charlesreid1.com/b-captain-hook/starting/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="..">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.3">
    
    
      
        <title>Getting Started - captain hook</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#ffa000">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
      <link rel="stylesheet" href="../css/custom.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="amber" data-md-color-accent="amber">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../#starting-captain-hook" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://pages.charlesreid1.com/b-captain-hook" title="captain hook" class="md-header-nav__button md-logo">
          
            <i class="md-icon">rowing</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                captain hook
              </span>
              <span class="md-header-nav__topic">
                Getting Started
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://git.charlesreid1.com/bots/b-captain-hook" title="Go to repository" class="md-source" data-md-source="">
    
    <div class="md-source__repository">
      captain-hook
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://pages.charlesreid1.com/b-captain-hook" title="captain hook" class="md-nav__button md-logo">
      
        <i class="md-icon">rowing</i>
      
    </a>
    captain hook
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://git.charlesreid1.com/bots/b-captain-hook" title="Go to repository" class="md-source" data-md-source="">
    
    <div class="md-source__repository">
      captain-hook
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Getting Started
      </label>
    
    <a href="./" title="Getting Started" class="md-nav__link md-nav__link--active">
      Getting Started
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#captain-hook-docker-pod" title="Captain Hook Docker "Pod"" class="md-nav__link">
    Captain Hook Docker "Pod"
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#startup-service-captain-hook-docker-pod" title="Startup Service: Captain Hook Docker Pod" class="md-nav__link">
    Startup Service: Captain Hook Docker Pod
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#startup-service-captain-hook-canary" title="Startup Service: Captain Hook Canary" class="md-nav__link">
    Startup Service: Captain Hook Canary
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../what/" title="What is Captain Hook?" class="md-nav__link">
      What is Captain Hook?
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../config/" title="Configuring Captain Hook" class="md-nav__link">
      Configuring Captain Hook
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../license/" title="Captain Hook License" class="md-nav__link">
      Captain Hook License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#captain-hook-docker-pod" title="Captain Hook Docker "Pod"" class="md-nav__link">
    Captain Hook Docker "Pod"
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#startup-service-captain-hook-docker-pod" title="Startup Service: Captain Hook Docker Pod" class="md-nav__link">
    Startup Service: Captain Hook Docker Pod
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#startup-service-captain-hook-canary" title="Startup Service: Captain Hook Canary" class="md-nav__link">
    Startup Service: Captain Hook Canary
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="starting-captain-hook">Starting Captain Hook</h1>
<p>NOTE: Captain Hook can be run by itself, but is designed to run
as part of the <a href="https://git.charlesreid1.com/docker/pod-webhooks">pod-webhooks</a>
docker pod. Instructions below are not guaranteed to work outside of
the docker pod.</p>
<h2 id="captain-hook-docker-pod">Captain Hook Docker "Pod"</h2>
<p>To run Captain Hook, we utilize a Docker compose file
to run the container that runs Captain Hook and mounts the
correct directories in the correct locations.</p>
<p>See <a href="https://github.com/charlesreid1/b-captain-hook/blob/master/docker-compose.yml">docker-compose.yml</a>
in the Captain Hook repository.</p>
<p>This is a one-container pod.</p>
<p>To start/stop/build it,</p>
<pre><code>docker-compose up -d   # start in background
docker-compose down
docker-compose build
</code></pre>

<p>To rebuild from scratch,</p>
<pre><code>docker-compose build --no-cache
</code></pre>

<h3 id="startup-service-captain-hook-docker-pod">Startup Service: Captain Hook Docker Pod</h3>
<p>In order to start the Captain Hook docker pod automatically
at startup, and automatically restart the pod if it crashes or
is stopped, we install a startup service called <code>dockerpod-captainhook</code>:</p>
<pre><code>[Unit]
Description=captain hook webhook server docker pod
Requires=docker.service
After=docker.service

[Service]
Restart=always
ExecStart=/usr/local/bin/docker-compose -f /home/charles/codes/bots/b-captain-hook/docker-compose.yml up
ExecStop=/usr/local/bin/docker-compose  -f /home/charles/codes/bots/b-captain-hook/docker-compose.yml down

[Install]
WantedBy=default.target
</code></pre>

<p>This startup service runs <code>docker-compose</code> with the <code>-f</code> flag to specify
an absolute path to the Captain Hook <code>docker-compose.yml</code> file.</p>
<h2 id="startup-service-captain-hook-canary">Startup Service: Captain Hook Canary</h2>
<p>Captain Hook listens for incoming web hooks and (optionally) runs a script in the <code>hooks/</code>
folder, based on the type of action, the name of the repository, and the
name of the branch.</p>
<p>However, there is one tricky task: Captain Hook must be able update <em>itself</em>
when there are changes pushed to the Captain Hook repository.</p>
<p>To resolve this, we run a "canary" startup service for Captain Hook.
This canary startup service runs a shell script that checks (every 10 seconds)
for the presence of a file at <code>/tmp/triggers/</code>.  If this file is present, the
host copy of Captain Hook is updated, the Captain Hook docker pod is restarted,
and the trigger file is removed.</p>
<p>This allows webhooks received by Captain Hook (which occur <em>inside</em> of a Docker
container) to trigger an event on the host machine by bind-mounting
<code>/tmp/triggers/</code> and adding a file to this directory.</p>
<p><strong><code>captain-hook-canary.service</code>:</strong></p>
<pre><code>[Unit]
Description=captain hook canary script
Requires=dockerpod-captainhook.service
After=dockerpod-captainhook.service

[Service]
Restart=always
ExecStart=/home/charles/blackbeard_scripts/captain_hook_canary.sh
ExecStop=/usr/bin/pgrep -f captain_hook_canary | /usr/bin/xargs /bin/kill 

[Install]
WantedBy=default.target
</code></pre>

<p>Also see <a href="https://git.charlesreid1.com/dotfiles/debian/src/branch/master/services/captain-hook-canary.service">captain-hook-canary.service</a>
in <a href="https://git.charlesreid1.com/dotfiles/debian">https://git.charlesreid1.com/dotfiles/debian</a>.</p>
<p>This script calls the Captain Hook canary script, which is given below:</p>
<p><strong><code>captain_hook_canary.sh</code>:</strong></p>
<pre><code>#!/bin/bash

: '
Captain Hook Canary Script


Note: this needs an associated systemd service.
See the services directory of the dotfiles repo.

(snip comments)
'

while true
do
    # bootstrap-pull captain hook
    if [ -f &quot;/tmp/triggers/push-b-captain-hook-master&quot; ]; then
        echo &quot;CAPTAIN HOOK'S CANARY:&quot;
        echo &quot;Running trigger to update Captain Hook on the host machine (user charles)&quot;
        sudo -H -u charles python /home/charles/blackbeard_scripts/captain_hook_pull_host.py
        echo &quot;All done.&quot;
        rm -f &quot;/tmp/triggers/push-b-captain-hook-master&quot;
    fi

    sleep 10;
done
</code></pre>

<p>Also see <a href="https://git.charlesreid1.com/dotfiles/debian/src/branch/master/dotfiles/blackbeard_scripts/captain_hook_canary.sh">captain_hook_canary.sh</a>
in the <code>dotfiles/blackbeard_scripts</code> folder of
<a href="https://git.charlesreid1.com/dotfiles/debian">https://git.charlesreid1.com/dotfiles/debian</a>.</p>
<p>When this canary script for Captain Hook is triggered by the presence of
a file at <code>/tmp/triggers/push-b-captain-hook-master</code> (which is mounted
inside the container at th same location as outside the container), it will
run a script to pull Captain Hook:</p>
<p><strong><code>captain_hook_pull_host.py</code>:</strong></p>
<pre><code>#!/usr/bin/env python3
import subprocess
import os
import time

&quot;&quot;&quot;
Captain Hook: Pull Captain Hook on the Host 

This script is called by the host machine 
(blackbeard) running the Captain Hook container.

This is triggered by push actions to the 
master branch of b-captain-hook.

The action is to update (git pull) the copy 
of captain hook running on the host, and
restart the container pod.
&quot;&quot;&quot;

work_dir = os.path.join('/home','charles','codes','bots','b-captain-hook')

# Step 1:
# Update Captain Hook
pull_cmd = ['git','pull','origin','master']
subprocess.call(pull_cmd, cwd=work_dir)

time.sleep(5)

# Step 2:
# Restart Captain Hook pod
pod_restart = ['docker-compose','restart']
subprocess.call(pod_restart, cwd=work_dir)

</code></pre>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href=".." title="Home" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Home
              </span>
            </div>
          </a>
        
        
          <a href="../what/" title="What is Captain Hook?" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                What is Captain Hook?
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 <a href="https://charlesreid1.com">Charles Reid</a>, released under the <a href="https://opensource.org/licenses/MIT">MIT license</a>
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.e72fd936.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
        <script src="../search/main.js"></script>
      
    
    
      
    
  </body>
</html>