



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://pages.charlesreid1.com/b-captain-hook/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="./">
      <meta name="generator" content="mkdocs-0.17.3, mkdocs-material-2.7.2">
    
    
      
        <title>captain hook</title>
      
    
    
      <link rel="stylesheet" href="./assets/stylesheets/application.8d40d89b.css">
      
        <link rel="stylesheet" href="./assets/stylesheets/application-palette.6079476c.css">
      
    
    
      <script src="./assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="./css/custom.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="yellow" data-md-color-accent="yellow">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#b-captain-hook" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://pages.charlesreid1.com/b-captain-hook" title="captain hook" class="md-header-nav__button md-logo">
          
            <i class="md-icon">rowing</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                captain hook
              </span>
              <span class="md-header-nav__topic">
                Home
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://git.charlesreid1.com/bots/b-captain-hook" title="Go to repository" class="md-source" data-md-source="">
    
    <div class="md-source__repository">
      captain-hook
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon">rowing</i>
      
    </span>
    captain hook
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://git.charlesreid1.com/bots/b-captain-hook" title="Go to repository" class="md-source" data-md-source="">
    
    <div class="md-source__repository">
      captain-hook
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Home
      </label>
    
    <a href="." title="Home" class="md-nav__link md-nav__link--active">
      Home
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dependencies" title="Dependencies" class="md-nav__link">
    Dependencies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-is-captain-hook" title="What is Captain Hook?" class="md-nav__link">
    What is Captain Hook?
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-short-version" title="The Short Version" class="md-nav__link">
    The Short Version
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-long-version" title="The Long Version" class="md-nav__link">
    The Long Version
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#starting-captain-hook" title="Starting Captain Hook" class="md-nav__link">
    Starting Captain Hook
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-hooks" title="Adding Hooks" class="md-nav__link">
    Adding Hooks
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="starting/" title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dependencies" title="Dependencies" class="md-nav__link">
    Dependencies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-is-captain-hook" title="What is Captain Hook?" class="md-nav__link">
    What is Captain Hook?
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-short-version" title="The Short Version" class="md-nav__link">
    The Short Version
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-long-version" title="The Long Version" class="md-nav__link">
    The Long Version
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#starting-captain-hook" title="Starting Captain Hook" class="md-nav__link">
    Starting Captain Hook
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-hooks" title="Adding Hooks" class="md-nav__link">
    Adding Hooks
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="b-captain-hook">b-captain-hook</h1>
<p>Captain hook is a Python WSGI appication that handles webhooks from gitea and
github.</p>
<p>Forked from <a href="https://github.com/carlos-jenkins/python-github-webhooks.git">carlos-jenkins/python-github-webhooks</a>.</p>
<p>To install captain hook:</p>
<pre><code>git clone https://git.charlesreid1.com/bots/b-captain-hook.git
cd b-captain-hook
</code></pre>

<h2 id="dependencies">Dependencies</h2>
<p>Install dependencies with pip:</p>
<pre><code>sudo pip install -r requirements.txt
</code></pre>

<p><br />
<br /></p>
<h2 id="what-is-captain-hook">What is Captain Hook?</h2>
<h3 id="the-short-version">The Short Version</h3>
<p>Captain Hook enables a Github Pages-like push-to-deploy setup for git.charlesreid1.com.</p>
<p>Installing webhooks into repositories on <a href="https://git.charlesreid1.com">https://git.charlesreid1.com</a>
allows the <code>gh-pages</code> branch of the given repository to be hosted live on
<a href="https://pages.charlesreid1.com">https://pages.charlesreid1.com</a>.</p>
<h3 id="the-long-version">The Long Version</h3>
<p>Captain Hook is a Python Flask server that listens for incoming web hooks from
Gitea (or Github), and uses those web hooks to deply pages to <a href="https://pages.charlesreid1.com">https://pages.charlesreid1.com</a>.</p>
<p>Captain Hook works by providing a webhook endpoint (rounting provided by nginx
container in <a href="https://git.charlesreid1.com/docker/pod-charlesreid">pod-charlesreid1</a>)
that can be used to link a Gitea (or Github) repository to Captain Hook.</p>
<p>Gitea (and Github) send payloads with webhooks that specify information like the
action that triggered the webhook, and the repository/branch on which the
action was performed.</p>
<p>Captain Hook runs inside of a docker container. The docker container mounts the
pages.charlesreid1.com web directory inside the container. Generally the hook
scripts will deploy the <code>gh-apges</code> branch to this web directory.</p>
<h2 id="starting-captain-hook">Starting Captain Hook</h2>
<p>See <a href="starting/">Starting Captain Hook</a> for how to set up the various startup services
and docker pods that are required to run Captain Hook.</p>
<p><br />
<br /></p>
<h2 id="adding-hooks">Adding Hooks</h2>
<p>Captain Hook will accept any incoming web hook that reaches it,
bt it will only run scripts if the event, repository name, and/or
branch to which changes were made matches the name of a script.</p>
<p>To add a new script to be triggered on a particular web hook:</p>
<pre><code>    hooks/{event}-{name}-{branch}
    hooks/{event}-{name}
    hooks/{event}
    hooks/all
</code></pre>

<p>For example, suppose I performed a <code>push</code> action to a repository
named <code>happy-giraffe</code>, and I was pushing commits to the <code>gh-pages</code>
branch. Then the webhook sent to Captain Hook would contain this
information, and Captain Hook would only run relevant scripts:
(in this case, <code>hooks/{event}-{name}-{branch}</code>).</p>
<p>The application passes the path to a JSON file, while holding the payload
for the request as the first argument. Suppose we had an event where someone
pushed to the <code>happy-giraffe</code> repository, to the <code>gh-pages</code> branch. </p>
<p>The application will pass in two pieces of information:</p>
<ul>
<li>
<p>Path to JSON file holding payload - the first part of the request
  is a JSON file that holds the payload for the request.</p>
</li>
<li>
<p>The other piece of information passed is the name of the action
    (e.g., <code>push</code>)</p>
</li>
</ul>
<p>The application will pass to the hooks the path to a JSON file holding the
payload for the request as first argument. The event type will be passed
as second argument. For example:</p>
<pre><code>    hooks/push-myrepo-master /tmp/sXFHji push
</code></pre>

<p>Hooks can be written in any scripting language as long as the file is
executable and has a shebang. A simple example in Python could be:</p>
<pre><code>    #!/usr/bin/env python
    # Python Example for Python GitHub Webhooks
    # File: push-myrepo-master

    import sys
    import json

    with open(sys.argv[1], 'r') as jsf:
      payload = json.loads(jsf.read())

    ### Do something with the payload
    name = payload['repository']['name']
    outfile = '/tmp/hook-{}.log'.format(name)

    with open(outfile, 'w') as f:
        f.write(json.dumps(payload))
</code></pre>

<p>Not all events have an associated branch, so a branch-specific hook cannot
fire for such events. For events that contain a <code>pull_request</code> object, the
base branch (target for the pull request) is used, not the head branch.</p>
<p>The payload structure depends on the event type. Please review:</p>
<pre><code>    https://developer.github.com/v3/activity/events/types/
</code></pre>

<h1 id="_1">=======================================</h1>
<p>This requires a config file. See <code>config.json</code>.</p>
<p><code>enforce_secret</code> - require <code>X-Hub-Signature</code> in header. Not enforced if empty.</p>
<p><code>return_scripts_info</code> - return a JSON with the <code>stdout</code>, <code>stderr</code> and exit
code for each executed hook using the hook name as key. If this option is set
you will be able to see the result of your hooks from within your GitHub
hooks configuration page (see "Recent Deliveries").</p>
<p><code>hooks_path</code> - Configures a path to import the hooks. Example: <code>/app/hooks</code></p>
<h2 id="adding-hooks_1">Adding Hooks</h2>
<p>This application will execute scripts in the hooks directory using the
following order:</p>
<p>(TODO: fix)</p>
<pre><code>    hooks/{event}-{name}-{branch}
    hooks/{event}-{name}
    hooks/{event}
    hooks/all
</code></pre>

<p>The application will pass to the hooks the path to a JSON file holding the
payload for the request as first argument. The event type will be passed
as second argument. For example:</p>
<pre><code>    hooks/push-myrepo-master /tmp/sXFHji push
</code></pre>

<p>Hooks can be written in any scripting language as long as the file is
executable and has a shebang. A simple example in Python could be:</p>
<pre><code>    #!/usr/bin/env python
    # Python Example for Python GitHub Webhooks
    # File: push-myrepo-master

    import sys
    import json

    with open(sys.argv[1], 'r') as jsf:
      payload = json.loads(jsf.read())

    ### Do something with the payload
    name = payload['repository']['name']
    outfile = '/tmp/hook-{}.log'.format(name)

    with open(outfile, 'w') as f:
        f.write(json.dumps(payload))
</code></pre>

<p>Not all events have an associated branch, so a branch-specific hook cannot
fire for such events. For events that contain a <code>pull_request</code> object, the
base branch (target for the pull request) is used, not the head branch.</p>
<p>The payload structure depends on the event type. Please review:</p>
<pre><code>    https://developer.github.com/v3/activity/events/types/
</code></pre>

<h2 id="docker-deployment">Docker Deployment</h2>
<p><code>Dockerfile</code> defines the image, but use the <code>docker-compose.yml</code> file instead.</p>
<p>To build, start, and stop:</p>
<pre><code>docker-compose build --no-cache
docker-compose up
docker-compose down
</code></pre>

<h3 id="ports">Ports</h3>
<p>This binds to external port 5000. </p>
<p>Implementing a secret key is critical to keep 
captain hook from deploying random strangers' 
webhook requests.</p>
<p>In our case, the hook is reverse-proxied by nginx on krash,
so we know what IP to expect. </p>
<p>(Problems implementing IP checking - 172 subrange, not 45 subrange.)</p>
<p>More important than validating the IP is validating the secret.</p>
<h3 id="volumes">Volumes</h3>
<p>THe docker container mounts the <code>hooks/</code> directory
in this repository to <code>/app/hooks</code> in the container.</p>
<pre><code>./hooks:/app/hooks
</code></pre>

<p><strong>NOTE: These scripts must be made executable with <code>chmod +x</code>
or the webhook server will not do anything and be totally silent.</strong></p>
<p>The docker container will also mount <code>/www/</code> into the container,
so all the static web content on the host (blackbeard) 
is available to the webhooks to perform updates and etc.</p>
<p><code>/www</code> is mounted to the same place on the host and in the container:</p>
<pre><code>/www:/www
</code></pre>

<h3 id="testing">Testing</h3>
<p>To test, you can trigger the webhook from the 
repository's webhooks panel.</p>
<p>Keep in mind this will <em>only</em> fire triggers
on the master branch.</p>
<h2 id="debugging">Debugging</h2>
<p>This container is an absolute pain in the ass to debug, 
and uses python 2 to boot. </p>
<p>But it was the only thing working.</p>
<p>To test: </p>
<ul>
<li>Run the server in one window</li>
<li>In a second window, open a shell in the container and monitor <code>/tmp/*.log</code></li>
<li>In a third window, open a shell in the container and monitor <code>/www/*</code></li>
</ul>
<p>To open a shell in the container:</p>
<pre><code>docker exec -it &lt;name-of-container&gt; /bin/sh
</code></pre>

<p>Remember you only have <code>/bin/sh</code> and <code>python2</code>,
no <code>bash</code> and no <code>python3</code>.</p>
<p>To check logs:</p>
<pre><code>docker logs -f &lt;container-name&gt;
</code></pre>

<p>You can also run the container without sending it
to the background,</p>
<pre><code>docker-compose up
</code></pre>

<p>and this will show exceptions on the screen
(but it won't show anything else useful...)</p>
<h2 id="license-from-forked-repo">License from Forked Repo</h2>
<p>Copyright (C) 2014-2015 Carlos Jenkins <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#99;&#97;&#114;&#108;&#111;&#115;&#64;&#106;&#101;&#110;&#107;&#105;&#110;&#115;&#46;&#99;&#111;&#46;&#99;&#114;">&#99;&#97;&#114;&#108;&#111;&#115;&#64;&#106;&#101;&#110;&#107;&#105;&#110;&#115;&#46;&#99;&#111;&#46;&#99;&#114;</a></p>
<p>Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<p>http://www.apache.org/licenses/LICENSE-2.0</p>
<p>Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.</p>
<h2 id="credits">Credits</h2>
<p>This project is just the reinterpretation and merge of two approaches:</p>
<p><a href="https://github.com/datafolklabs/github-webhook-wrapper">github-webhook-wrapper</a></p>
<p><a href="https://github.com/razius/flask-github-webhook">flask-github-webhook</a></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
        
          <a href="starting/" title="Getting Started" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Getting Started
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 <a href="https://charlesreid1.com">Charles Reid</a>, released under the <a href="https://opensource.org/licenses/MIT">MIT license</a>
          </div>
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="./assets/javascripts/application.0cf9b500.js"></script>
      
      <script>app.initialize({version:"0.17.3",url:{base:"."}})</script>
      
        <script src="./search/require.js"></script>
      
        <script src="./search/search.js"></script>
      
    
    
      
    
  </body>
</html>